<!DOCTYPE html>
<html>
    <body id="dashboardBody">
        <script src="/js/jquery.min.js"></script>
        <script src="/js/plotly-latest.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        <script src="/js/imuJS/three.min.js"></script>
        <script src="/js/imuJS/DDSLoader.js"></script>
        <script src="/js/imuJS/MTLLoader.js"></script>
        <script src="/js/imuJS/OBJMTLLoader.js"></script>
        <script src="/js/imuJS/OBJLoader.js"></script>
        <script src="/js/imuJS/STLLoader.js"></script>
              
        <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="/css/bootstrap-theme.min.css" />
        <link rel="stylesheet" type="text/css" href="/css/miscDashboard.css" />
        <script src="/js/socket.io.min.js"></script>
        <div id="gpsDiv" class="divider">
            <div class="container-fluid d-flex h-100 flex-column">
                <div class="row">
                    <div class="col col-sm-2">
                        <h4 class="bold">GPS</h4>
                    </div>
                    <div class="col col-sm-2" id="fixField">--</div>
                    <div class="col col-sm-8 subheading" id="timeField">--</div>
                </div>
                <div class="row">
                    <div class="col col-sm-4">Latitude:</div>
                    <div class="col col-sm-3" id="latitudeField">--</div>
                    <div class="col col-sm-2">+/-</div>
                    <div class="col col-sm-2" id="latitudeErrField">--</div>
                </div>
                <div class="row paddingTop">
                    <div class="col col-sm-4">Longitude:</div>
                    <div class="col col-sm-3" id="longitudeField">--</div>
                    <div class="col col-sm-2">+/-</div>
                    <div class="col col-sm-2" id="longitudeErrField">--</div>
                </div>
                <div class="row paddingTop">
                    <div class="col col-sm-4">Altitude(m):</div>
                    <div class="col col-sm-3" id="altitudeField">--</div>
                    <div class="col col-sm-2">+/-</div>
                    <div class="col col-sm-2" id="altitudeErrField">--</div>
                </div>
                <div class="row hidden">
                    <div class="col col-sm-4">Speed(mph):</div>
                    <div class="col col-sm-3" id="speedField">--</div>
                    <div class="col col-sm-2">+/-</div>
                    <div class="col col-sm-2" id="speedErrField">--</div>
                </div>
                <div class="row paddingTop">
                    <div class="col col-sm-4">Climb(m/s):</div>
                    <div class="col col-sm-3" id="climbField">--</div>
                    <div class="col col-sm-2">+/-</div>
                    <div class="col col-sm-2" id="climbErrField">--</div>
                </div>
                <div class="row paddingTop">
                    <div class="col col-sm-4">Heading&deg;:</div>
                    <div class="col col-sm-3" id="headingField">--</div>
                    <div class="col col-sm-2"></div>
                    <div class="col col-sm-2"></div>
                </div>
                <div class="row hidden">
                    <div class="col-sm">Grid Square:</div>
                    <div class="col-sm"></div>
                    <div class="col-sm"></div>
                    <div class="col-sm"></div>
                </div>
            </div>
        </div>
        <div id="imuDIV" class="divider">

            <div class="container-fluid">
                <div class="row">
                    <div class="col col-sm-3">
                        <h4 class="bold">Pitch&deg;</h4>
                    </div>
                    <div class="col col-sm-2">
                        <h4 id="pitch">--</h4>
                    </div>
                    <div class="col col-sm-3">
                        <h4 class="bold">Roll&deg;</h4>
                    </div>
                        <h4 id="roll">--</h4>
                    <div class="col col-sm-2">
                        <div class="bttn" id="straighten">S</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12" id="renderer">
                    </div>
                </div>
              </div>
        </div>
        <div id="airQualityDiv" class="divider">
            <div class="container-fluid d-flex h-100 flex-column">
                <div class="row">
                    <div class="col col-sm-6">
                        <h4 class="bold">Air Quality</h4>
                    </div>
                </div>
                <div class="row h-100">
                    <div class="col col-sm-3" id="pm10Header">PM1.0:</div>
                    <div class="col col-sm-2" id="pm10Field">--</div>
                    <div class="col col-sm-7 padding-0 borderGreen" id="pm10BarContainer">
                        <div class="bar" id="pm10Bar">-</div>
                    </div>
                </div>
                <div class="row h-100">
                    <div class="col col-sm-3" id="pm25Header">PM2.5:</div>
                    <div class="col col-sm-2" id="pm25Field">--</div>
                    <div class="col col-sm-7 padding-0 borderGreen" id="pm25BarContainer">
                        <div class="bar" id="pm25Bar">-</div>
                    </div>
                </div>
                <div class="row h-100">
                    <div class="col col-sm-3" id="pm100Header">PM10:</div>
                    <div class="col col-sm-2" id="pm100Field">--</div>
                    <div class="col col-sm-7 padding-0 borderGreen" id="pm100BarContainer">
                        <div class="bar" id="pm100Bar">-</div>
                    </div>
                </div>
                <div class="row hidden">
                    <div class="col col-sm-6" id="pm3umHeader">PM > .3um / 0.1L air:</div>
                    <div class="col col-sm-2" id="pm3umField">--</div>
                </div>
                <div class="row hidden">
                    <div class="col col-sm-6" id="pm5umHeader">PM > .5um / 0.1L air:</div>
                    <div class="col col-sm-2" id="pm5umField">--</div>
                </div>
                <div class="row hidden">
                    <div class="col col-sm-6" id="pm10umHeader">PM > 1.0um / 0.1L air:</div>
                    <div class="col col-sm-2" id="pm10umField">--</div>
                </div>
                <div class="row hidden">
                    <div class="col col-sm-6" id="pm25umHeader">PM > 2.5um / 0.1L air:</div>
                    <div class="col col-sm-2" id="pm25umField">--</div>
                </div>
                <div class="row hidden">
                    <div class="col col-sm-6" id="pm50umHeader">PM > 5.0um / 0.1L air:</div>
                    <div class="col col-sm-2" id="pm50umField">--</div>
                </div>
                <div class="row hidden">
                    <div class="col col-sm-6" id="pm100umHeader">PM > 10um / 0.1L air:</div>
                    <div class="col col-sm-2" id="pm100umField">--</div>
                </div>
                <div class="row hidden">
                    <div class="col col-sm-6" id="airQualityErrorHeader">Read Errors:</div>
                    <div class="col col-sm-2" id="airQualityErrorField">0</div>
                </div>
            </div>
        </div>
        <div id="miscDataDiv" class="divider">
            <div class="container-fluid">
                <div class="row">
                    <div class="col col-sm-3">Accel:</div>
                    <div class="col col-sm-2">--</div>
                    <div class="col col-sm-3">Gs:</div>
                    <div class="col col-sm-2">--</div>
                </div>
                <div class="row">
                    <div class="col col-sm-3" id="cpuTempHeader">CPU &deg;F:</div>
                    <div class="col col-sm-2" id="cpuTempField">--</div>
                </div>
                <div class="row">
                    <div class="col col-sm-3" id="logsHeader">Logs:</div>
                </div>
                <div class="logContainer">
                    <div class="row log pad-left"><div>[22:32:31] [ERR]: AIR - RuntimeError - Invalid PM2.5 checksum</div></div>
                </div>
            </div>
        </div>
    </body>
</html>

<script>

    
</script>

<script>
    var DEFAULT_COLOR = '#00ba00'
    
    //Ceiling values are based on
    //https://www3.epa.gov/region1/airquality/pm-aq-standards.html
    //There are no recommendations on PM1.0 values.  Ideally should be close to 0 as possible. Most harmful particulate matter
    //Note PM10 is PM1.0, PM25 is PM2.5, and PM100 is PM10
    var PM10_AIR_CEILING = 14 * 2;//no offical recommended value. Multiply by 2 to set max num particles per bar
    var PM25_AIR_CEILING = 35 * 2;//recommended 12 ug/m3 or less for annual PM2.5 standard. 35 ug/m3 for daily value
    var PM100_AIR_CEILING = 54 * 2; //recommended 150 ug/m3 per day. 50 ug/m3 for annual value, but was revoked sept 2006
    var GOOD_AIR_COLOR = DEFAULT_COLOR; //neon-ish green
    var FAIR_AIR_COLOR = 'yellow';
    var POOR_AIR_COLOR = 'rgb(255, 0, 0)'; //red. RGB value used for easier comparison logic later
    var PM10_BAR_SCALAR = 100 / PM10_AIR_CEILING; //scalar used to accurately change bar graph size and color based on ceilings
    var PM25_BAR_SCALAR = 100 / PM25_AIR_CEILING;
    var PM100_BAR_SCALAR = 100 / PM100_AIR_CEILING;
    
    var barGraphs = [
        $("#pm10Bar"),
        $("#pm25Bar"),
        $("#pm100Bar")
    ];

    
    $(document).ready(() => {
        
        /*begin code to setup listeners for data*/
        
        var socket = io();
        if (socket != null) {
            $("#statusField").text = "Connected";
        }
        
        socket.on("airQualityData", function(msg) {
            updateAirQualityStats(msg);
        });
        
        socket.on("log", function(msg) {
            updateLogs(msg);
        });

        socket.on("gpsData", function(msg) {
            updateGpsStats(msg);
        });
        
        socket.on("imuData", function(msg) {
            updateSensorData(msg);
        });
        
        //set the air quality bars to flash if they are red
        setInterval(() => {
            for (i = 0; i < barGraphs.length; i++) {
                var rgbColor = barGraphs[i].css("background-color");

                if (rgbColor == POOR_AIR_COLOR) {
                    barGraphs[i].toggleClass("hidden");
                } else {
                    barGraphs[i].removeClass("hidden");
                }
            }
        }, 1000); //in ms
        
        /*begin code for IMU webgl render section
        //a lot of the webgl three js code is based on 
        //https://github.com/adafruit/Adafruit_CircuitPython_BNO055.git
        */
        
        var meshFloor = new THREE.Mesh(
            new THREE.PlaneGeometry(100, 50, 15, 15),
            new THREE.MeshBasicMaterial({
                color: DEFAULT_COLOR,
                wireframe: true
            })
        );
        meshFloor.rotation.x -= Math.PI / 2;

        // Set size of the WebGL renderer scene.
        var sceneWidth = $("#imuDIV").width();
        var sceneHeight = $("#imuDIV").height() - 50;

        var models = [{
            name: 'Miata',
            load: function(model) {
                stlLoader.load(
                    'objects/miata.stl',
                    function(geometry) {
                        // Regenerate normals because they aren't loaded properly.
                        geometry.computeFaceNormals();
                        geometry.computeVertexNormals();
                        // Load the model and build mesh.
                        model.model = new THREE.Mesh(geometry, material);
                        // Rotate, scale, and move so the cat is facing out the screen.
                        model.model.rotation.x = -90 * (Math.PI / 180.0);
                        model.model.rotation.z = -180 * (Math.PI / 180.0);
                        model.model.scale.set(5, 5, 5);
                        model.model.position.y = 1.5;
                    }
                );
            }
        }];

        // Global state.
        var bnoData = null;
        var offset = null;
        var orientation = null;
        var objMTLLoader = new THREE.OBJMTLLoader();
        var stlLoader = new THREE.STLLoader();
        var currentModel = null;

        // Setup Three.js scene and camera.
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(45, sceneWidth / sceneHeight, 1, 1000);


        // Setup Three.js WebGL renderer and add it to the page.
        var renderer = new THREE.WebGLRenderer({
            antialias: true
        });
        renderer.setSize(sceneWidth, sceneHeight);
        renderer.setClearColor(0xff0000, 0);
        $('#renderer').append(renderer.domElement);
        $('#renderer canvas').addClass('center-block'); // Center the renderer.

        //try to center car and zoom out to appropriate distance 
        camera.position.set(0, 6, 20);


        // Create default green material for the model
        var material = new THREE.MeshPhongMaterial({
            color: DEFAULT_COLOR,
            wireframe: false
        });

        // Setup 3 point lighting with a green point light in upper left
        // and right corners, plus a bit of backlight from the rear forward.
        var pointLight1 = new THREE.PointLight('white', 0.6);
        pointLight1.position.set(40, 15, 40);
        scene.add(pointLight1);
        var pointLight2 = new THREE.PointLight('white', 0.6);
        pointLight2.position.set(-40, 15, 40);
        scene.add(pointLight2);
        var backLight = new THREE.DirectionalLight('white', 0.3);
        backLight.position.set(0, -0.25, -1);
        scene.add(backLight);

        // Create a couple groups to apply rotations to the 3D model at different
        // stages.  The outer group called offset is set to the reverse rotation
        // of the current BNO orientation when the 'Straighten' button is clicked.
        // This will force the model to center itself staring directly out of
        // the screen.  The inner group called orientation will be rotated with
        // the current BNO sensor orientation and cause the model to rotate.
        offset = new THREE.Group();
        orientation = new THREE.Group();
        offset.add(orientation);
        scene.add(offset);
        scene.add(meshFloor);

        // Main rendering function.
        function render() {
            requestAnimationFrame(render);
            // Switch to the first model once it's loaded.
            if (currentModel === null) {
                if (models[0].hasOwnProperty('model')) {
                    currentModel = 0;
                    orientation.add(models[0].model);
                }
            }
            // Update the orientation with the last BNO sensor reading quaternion.
            if (bnoData !== null) {
                orientation.quaternion.set(bnoData.quatY, 0, bnoData.quatZ, bnoData.quatW); // note the swapping of x, y in args for correct orientation
            }
            renderer.render(scene, camera);
        }

        render();

        //zeros/resets the orientation of the car model
        $('#straighten').click(function() {
            // Get the current orientation of the BNO sensor and compute its
            // conjugate or reverse rotation and apply it to the offset group.
            // This will reset the 3D model so that it faces directly forward based
            // on the current BNO sensor orientation.
            var currentQuat = new THREE.Quaternion(bnoData.quatY, 0, bnoData.quatZ, bnoData.quatW); // note the swapping of x, y in args for correct orientation
            offset.quaternion.copy(currentQuat.conjugate());
        });

        // Populate 3D models and load 
        $.each(models, function(index, model) {
            model.load(model);
        });


        //begin code for calling code to update all data on the page
        
        function updateLogs(msg) {
            var data = $.parseJSON(msg);
            var tbody = $("#logTable").children("tbody");
            var table = tbody.length ? tbody : $("#logTable");
            
            table.append('<div class="row log pad-left"><div>' + "[" + data['timeStamp'] + "] [" + data['logType'] + "]: " + data['sensor'] + " - " + data['exType'] + " - " + data['args'] + "</div></div>");

            var objDiv = document.getElementById("logTable");
            objDiv.scrollTop = objDiv.scrollHeight;
        }
        
        function updateAirQualityBar(barTextField, bar, barContainer, numParticles, scalar) {
            
            var percent = numParticles * scalar; //percent of bar to remove based on num particles

            if (percent >= 100) {
                bar.width('100%');
            } else {
                bar.width(percent + '%');
            }
            
            if (percent <= 50) { // 50% of ceiling is the max recommended exposure amount
                barTextField.css('color', GOOD_AIR_COLOR);
                barContainer.css('border-color', GOOD_AIR_COLOR);
                bar.css('background-color', GOOD_AIR_COLOR);
            } else if (percent > 50 && percent <= 70) {
                barTextField.css('color', FAIR_AIR_COLOR);
                barContainer.css({"border-color": FAIR_AIR_COLOR});
                bar.css('background-color', FAIR_AIR_COLOR);
            } else {
                barTextField.css('color', POOR_AIR_COLOR);
                barContainer.css({"border-color": POOR_AIR_COLOR});
                bar.css('background-color', POOR_AIR_COLOR);
            }
        }
        
        function updateAirQualityStats(msg) {
            var data = $.parseJSON(msg);
            
            var pm10 = data["pm10"];
            var pm25 = data["pm25"];
            var pm100 = data["pm100"];
            
            $("#pm10Field").text(pm10);
            $("#pm25Field").text(pm25);
            $("#pm100Field").text(pm100);
            $("#pm3umField").text(data["pm3um"]);
            $("#pm5umField").text(data["pm5um"]);
            $("#pm10umField").text(data["pm10um"]);
            $("#pm25umField").text(data["pm25um"]);
            $("#pm50umField").text(data["pm50um"]);
            $("#pm100umField").text(data["pm100um"]);
            
            
            updateAirQualityBar($("#pm10Field"), $("#pm10Bar"), $("#pm10BarContainer"), pm10, PM10_BAR_SCALAR);
            updateAirQualityBar($("#pm25Field"), $("#pm25Bar"), $("#pm25BarContainer"), pm25, PM25_BAR_SCALAR);
            updateAirQualityBar($("#pm100Field"), $("#pm100Bar"), $("#pm100BarContainer"), pm100, PM100_BAR_SCALAR);
        }
        
        function updateGpsStats(msg) {
            var data = $.parseJSON(msg);
            var date = new Date(data["time"]);
            
            $("#fixField").text("[" + data["fixType"] + "]");
            $("#timeField").text(date.toUTCString());
            //$("#timeErrField").text(data["timeErr"]);
            $("#latitudeField").text(data["latitude"]);
            $("#latitudeErrField").text(data["latitudeErr"]);
            $("#longitudeField").text(data["longitude"]);
            $("#longitudeErrField").text(data["longitudeErr"]);
            $("#altitudeField").text(data["altitude"]);
            $("#altitudeErrField").text(data["altitudeErr"]);
            $("#speedField").text(data["speed"]);
            $("#speedErrField").text(data["speedErr"]);
            $("#climbField").text(data["climb"]);
            $("#climbErrField").text(data["climbErr"]);
            //$("#headingField").text(data["heading"]);
        }
        
        function updateSensorData(msg) {
            var data = $.parseJSON(msg);
            var pitch = data.roll.toFixed(1); //need to reverse pitch and roll for accurate orientation. Mismatch somewhere?
            var roll = data.pitch.toFixed(1); //sensor is being layed on a flat surface
            bnoData = data;
            
            $('#heading').text(data.heading);
            $('#roll').text(roll);
            $('#pitch').text(pitch);
            $('#calSys').text(data.calSys);
            $('#calGyro').text(data.calGyro);
            $('#calAccel').text(data.calAccel);
            $('#calMag').text(data.calMag);
        }
    
    });
</script>
