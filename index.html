<!DOCTYPE html>
<html>
    <head>
        <title>piObdDashboard</title>
    </head>
    <body>
        <script src="/js/jquery.min.js"></script>
        <script src="/js/plotly-latest.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        <link rel="stylesheet" type="text/css" href="/css/index.css" />
        <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="/css/bootstrap-theme.min.css" />

        <script src="/js/socket.io.min.js"></script>

        <div class="container">
            <span>Status:</span>
            <span id="statusField"></span>
        </div>

        <div class="container pad-left">
            <div class="row">
                <div class="col-xs-4 left">
                    <h1 class="mph" id="speedField">--</h1>
                    <h4>MPH</h4>
                </div>
                <div class="col-xs-4 pad-left">
                    <h1 class="rpm" id="rpmField">--</h1>
                    <h4>RPM</h4>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-4">
                    <h3 id="throttleField">--</h3>
                    <h6>% Throttle</h6>
                </div>
                <div class="col-xs-4 pad-left">
                    <h3 id="cabinTempField">--</h3>
                    <h6>Cabin Temp (F)</h6>
                </div>
                <div class="col-xs-4 pad-left">
                    <h3 id="cabinHumidityField">--</h3>
                    <h6>Humidity %</h6>
                </div>
            </div>
        </div>
        <div class="wrapper">
            <script>
               
            </script>
            <div id="speedChart"></div>
            <script>
                var startTime = new Date($.now());
                var x_max = 500;
                var mphColor = '#1F77B4';

                 var speedLayout = {
                     autosize: true,
                     height: 300,

                     margin: {
                       l: 55,
                       r: 10,
                       b: 25,
                       t: 10,
                       pad: 1
                     },
                     xaxis: {
                        <!--tickformat: "%I:%M" -->
                        tickangle: 0,
                        nticks: 6,
                        gridcolor: mphColor
                     },
                     yaxis: {
                        <!-- rangemode:'tozero' -->
                        gridcolor: mphColor
                     },
                     font: {
                       size: 20,
                       color: mphColor
                     }
                     <!-- paper_bgcolor: '#000000', -->
                      <!-- plot_bgcolor: '#c7c7c7' -->
                 };

                 Plotly.react('speedChart',[{
                      x:[startTime],
                     y:[0],
                     type:'line',

                     line: {
                      width: 1
                   },
                   fill: 'tozeroy'
                 }], speedLayout);

                 var cntSpeed = 0;

                 function updateSpeedChart(speed, time) {
                    $("#speedField").text(speed);
                    
                    var speedTrace = {
                       x:[[time]],
                       y:[[speed]]
                    }
                     Plotly.extendTraces('speedChart', speedTrace, [0], x_max);

                 }
            </script>
        </div>
        <div class="wrapper">
            <div id="rpmChart"></div>
            <script>
                var rpmColor = '#00ba00';

                 var rpmLayout = {
                       autosize: true,
                       height: 300,
                       margin: {
                          l: 55,
                          r: 10,
                        b: 25,
                        t: 10,
                        pad: 1
                      },
                      xaxis: {
                         <!--tickformat: "%I:%M" -->
                         tickangle: 0,
                         nticks: 6,
                         gridcolor: rpmColor
                      },
                      yaxis: {
                         gridcolor: rpmColor
                      },
                      font: {
                        size: 20,
                        color: rpmColor
                      }
                      <!-- paper_bgcolor: '#000000', -->
                       <!-- plot_bgcolor: '#c7c7c7' -->
                 };

                  Plotly.react('rpmChart',[{
                    x:[startTime],
                      y:[0],
                      type:'line',
                    line: {
                       color: rpmColor,
                       width: 1
                    },
                    fill: 'tozeroy'

                  }], rpmLayout);

                  var cnt = 0;

                  function updateRpmChart(rpm, time) {
                     $("#rpmField").text(rpm);
                     
                     var scaledRpm = (rpm / 1000).toFixed(3);
                     var rpmTrace = {
                        x:[[time]],
                        y:[[scaledRpm]]
                     }

                      Plotly.extendTraces('rpmChart', rpmTrace, [0], x_max);

                  }
            </script>
        </div>
        <script>
            function updateCabinTempHumidity(temp, humidity) {
               $("#cabinTempField").text(temp);
               $("#cabinHumidityField").text(humidity);
            }
            var socket = io();
            if (socket != null) {
                $("#statusField").text = "Connected";
            }

            socket.on("data", function (msg) {
                var currentTime = new Date($.now());

                var carData = $.parseJSON(msg);
                var speed = parseInt(carData["speed"]);
                var rpm = parseInt(carData["rpm"]);
                var throttle = parseInt(carData["throttle"]);
                var cabinTemp;

                $("#throttleField").text(throttle);
                
                updateSpeedChart(speed, currentTime);
                updateRpmChart(rpm, currentTime);
            });
            
            socket.on("cabinTempHumidity", function (msg) {
               var data = $.parseJSON(msg);
               var temp = data["temp"];
               var humidity = data["humidity"];
               
               updateCabinTempHumidity(temp, humidity);
            });
        </script>
        <div class="container">
            <table id="myTable" class="table" data-toggle="table" data-mobile-responsive="true" data-pagination="true">
                <thead>
                    <tr>
                        <th>Error Code (DTC)</th>
                        <th>Description</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <script>
            var tbody = $("#myTable").children("tbody");
            var table = tbody.length ? tbody : $("#myTable");

            socket.on("faultCodeData", function (faultCodes) {
                table.empty();
                for (var i = 0; i < faultCodes.length; i++) {
                    var codeDescArray = faultCodes[i];
                    var code = codeDescArray[0];
                    var description = codeDescArray[1];

                    //Only add row if fault code doesn't exist in table.
                    table.append("<tr id=" + code + "><td>" + code + "</td><td>" + description + "</td></tr>");
                }
            });
        </script>
    </body>
</html>
