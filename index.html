<!DOCTYPE html>
<html>
    <head>
        <title>piObdDashboard</title>
    </head>
    <body>
        <script src="/js/jquery.min.js"></script>
        <script src="/js/plotly-latest.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        <link rel="stylesheet" type="text/css" href="/css/index.css" />
        <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="/css/bootstrap-theme.min.css" />

        <script src="/js/socket.io.min.js"></script>

        <div class="container">
            <span>Status:</span>
            <span id="statusField"></span>
        </div>

        <div class="container">
            <div class="row">
 
                
                <table class="telemetry-table">
                    <tbody>
                        <tr>
                            <td>
                              <h4 class="pad-left">MPH</h4>
                                <h1 class="mph pad-right" id="speedField">--</h1>
                                
                            </td>
                            <td>
                                <table>
                                    <tbody>
                                        <tr>
                                            <td><h4>RPM</h4></td>
                                        </tr>
                                        <tr>
                                            <td><h1 class="rpm rpmCell" id="rpmField">--</h1></td>
                                        </tr>
                                        <tr>
                                            <td class="pad-top"><h3 id="throttleField">--</h3></td>
                                            <td  class="col-sm-4"><h3 id="cabinTempField">--</h3></td>
                                            <td class="col-sm-4"><h3 id="cabinHumidityField">--</h3></td>
                                        </tr>
                                        <tr>
                                            <td><h6>% Throttle</h6></td>
                                            <td class="col-sm-4"><h6 id="cabinTempHeader">Cabin Temp</h6></td>
                                            <td class="col-sm-4"><h6>% Humidity</h6></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                
                
            </div>
        </div>
        <div class="wrapper">
            <script></script>
            <div id="speedChart"></div>
            <script>
                var degreeSymbol = String.fromCharCode(176);
                var degreeMetric = "F";
                $("#cabinTempHeader").text("Cabin Temp " + degreeSymbol + degreeMetric);

                var startTime = new Date($.now());
                var x_max = 500; //max number of data points per plot
                var defaultColor = '#00ba00';
                var plotBackgroundColor = '#000000';
                

                 var speedLayout = {
                     autosize: true,
                     height: 300,

                     margin: {
                       l: 55,
                       r: 10,
                       b: 25,
                       t: 10,
                       pad: 1
                     },
                     xaxis: {
                        <!--tickformat: "%I:%M" -->
                        tickangle: 0,
                        nticks: 6,
                        gridcolor: defaultColor
                     },
                     yaxis: {
                        <!-- rangemode:'tozero' -->
                        gridcolor: defaultColor
                     },
                     font: {
                       size: 20,
                       color: defaultColor
                     },
                     paper_bgcolor: plotBackgroundColor,
                     plot_bgcolor: plotBackgroundColor
                 };

                 Plotly.react('speedChart',[{
                      x:[startTime],
                     y:[0],
                     type:'line',

                     line: {
                        color: defaultColor,
                      width: 1
                   },
                   fill: 'tozeroy'
                 }], speedLayout);


                 function updateSpeedChart(speed, time) {
                    var speedingSpeed = 85000;
                    var warningSpeed = 80;
                    var parsedSpeed = parseInt(speed);

                    $("#speedField").text(speed);


                    var speedTrace = {
                       x:[[time]],
                       y:[[speed]]
                    }
                     Plotly.extendTraces('speedChart', speedTrace, [0], x_max);

                 }
            </script>
        </div>
        <div class="wrapper">
            <div id="rpmChart"></div>
            <script>
                 var rpmLayout = {
                       autosize: true,
                       height: 300,
                       margin: {
                          l: 55,
                          r: 10,
                        b: 25,
                        t: 10,
                        pad: 1
                      },
                      xaxis: {
                         <!--tickformat: "%I:%M" -->
                         tickangle: 0,
                         nticks: 6,
                         gridcolor: defaultColor
                      },
                      yaxis: {
                         gridcolor: defaultColor
                      },
                      font: {
                        size: 20,
                        color: defaultColor
                      },
                      paper_bgcolor: plotBackgroundColor,
                      plot_bgcolor: plotBackgroundColor
                 };

                  Plotly.react('rpmChart',[{
                    x:[startTime],
                      y:[0],
                      type:'line',
                    line: {
                       color: defaultColor,
                       width: 1
                    },
                    fill: 'tozeroy'

                  }], rpmLayout);

                  var cnt = 0;

                  function updateRpmChart(rpm, time) {
                    var highRpm = 6500;
                    var mediumRpm = 4000;
                    var parsedRpm = parseInt(rpm);

                    $("#rpmField").text(rpm);

                    if (parsedRpm >= highRpm) {
                        $("#rpmField").css('color', 'red');
                    } else if (parsedRpm >= mediumRpm && parsedRpm < highRpm) {
                        $("#rpmField").css('color', 'yellow');
                    } else {
                        $("#rpmField").css('color', defaultColor);
                    }

                     var scaledRpm = (rpm / 1000).toFixed(3);
                     var rpmTrace = {
                        x:[[time]],
                        y:[[scaledRpm]]
                     }

                      Plotly.extendTraces('rpmChart', rpmTrace, [0], x_max);

                  }
            </script>
        </div>
        <script>
            function updateCabinTempHumidity(temp, humidity) {
                $("#cabinTempField").text(temp);
                $("#cabinHumidityField").text(humidity);
            }
            var socket = io();
            if (socket != null) {
                $("#statusField").text = "Connected";
            }

            socket.on("data", function (msg) {
                var currentTime = new Date($.now());

                var carData = $.parseJSON(msg);
                var speed = parseInt(carData["speed"]);
                var rpm = parseInt(carData["rpm"]);
                var throttle = parseInt(carData["throttle"]);
                var cabinTemp;

                $("#throttleField").text(throttle);

                updateSpeedChart(speed, currentTime);
                updateRpmChart(rpm, currentTime);
            });

            socket.on("cabinTempHumidity", function (msg) {
                var data = $.parseJSON(msg);
                var temp = data["temp"];
                var humidity = data["humidity"];

                updateCabinTempHumidity(temp, humidity);
            });
        </script>
        <div class="container">
            <table id="myTable" class="table" data-toggle="table" data-mobile-responsive="true" data-pagination="true">
                <thead>
                    <tr>
                        <th>Error Code (DTC)</th>
                        <th>Description</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <script>
            var tbody = $("#myTable").children("tbody");
            var table = tbody.length ? tbody : $("#myTable");

            //this should only get called when there is a change in DTC(s). That logic
            //is handled in piObd.py. We clear the table and add the codes + descriptions
            socket.on("dtcData", function (faultCodes) {
                table.empty();
                for (var i = 0; i < faultCodes.length; i++) {
                    var codeDescArray = faultCodes[i];
                    var code = codeDescArray[0];
                    var description = codeDescArray[1];

                    table.append("<tr id=" + code + "><td>" + code + "</td><td>" + description + "</td></tr>");
                }
            });
        </script>
    </body>
</html>
